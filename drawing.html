<html>
<head>
	<script type="text/javascript">
	var canvas,
		parent_div,
		pen,
		erase,
		text,
		ctx, 
		reader,
		selectedText,
		flag = false,
		prevX = 0,
		currX = 0,
		prevY = 0,
		currY = 0,
		dot_flag = false,
		tool = 1; // 1:pen, 2:erase, 3:text
		offsetLeft = 0
		offsetTop = 0,
		hasInput = false,
		font = '14px sans-serif';

	var pen_color = "black",
		pen_width = 2;
	
	function init() {
		parent_div = document.getElementById('the-palace');
		offsetLeft = parent_div.offsetLeft;
		offsetTop = parent_div.offsetTop;
		reader = new FileReader();

		document.getElementById('btn_load').style.pointerEvents = 'none';
		document.getElementById('btn_save').style.pointerEvents = 'none';
		canvas = document.getElementById('can');
		pen = document.getElementById('pen');
		erase = document.getElementById('erase');
		text = document.getElementById('text');
		pen.checked = true;
		console.log(parent_div.offsetWidth);
		canvas.width = parent_div.offsetWidth;
		canvas.height = parent_div.offsetHeight;

		ctx = canvas.getContext("2d");
		w = canvas.width;
		h = canvas.height;

		console.log(w);

		canvas.addEventListener("mousemove", function (e) {
			findxy('move', e)
		}, false);
		canvas.addEventListener("mousedown", function (e) {
			findxy('down', e)
		}, false);
		canvas.addEventListener("mouseup", function (e) {
			findxy('up', e)
		}, false);
		canvas.addEventListener("mouseout", function (e) {
			findxy('out', e)
		}, false);
		canvas.addEventListener('click', function(e) {
			if(tool === 3) {
				if(selectedText) 
					selectedText.style.border = 'none';
					clickCanvas(e);
			}
		}, false);
	}
	
	function color(obj) {
		let color = obj.value.toLowerCase();
		pen_color = color;
		selectPen();
	}
	
	function draw() {
		if(tool === 2) {
			ctx.clearRect(currX, currY, 15, 15);
		} else if(tool === 1) {
			ctx.beginPath();
			ctx.moveTo(prevX, prevY);
			ctx.lineTo(currX, currY);
			ctx.strokeStyle = pen_color;
			ctx.lineWidth = pen_width;
			ctx.stroke();
			ctx.closePath();
		}
	}
	
	function eraseAll() {
		ctx.clearRect(0, 0, w, h);
	}
	
	function save() {
		document.getElementById("downloader").download = "image.png";
    	document.getElementById("downloader").href = canvas.toDataURL("image/png");
	}
	
	function clickCanvas(e) {
		currX = e.clientX - canvas.offsetLeft;
		currY = e.clientY - canvas.offsetTop;

		console.log(currX + '-' + currY);

		var input = document.createElement('textarea');
		selectedText = input;
		input.type = 'text';
		input.style.position = 'fixed';
		input.style.left = (currX) + 'px';
		input.style.top = (currY) + 'px';
		input.oninput = 'this.style.height = "";this.style.height = this.scrollHeight + "px"';

		input.onkeydown = handleEnter;

		document.body.appendChild(input);

		input.focus();
		hasInput = true;
	}

	function handleEnter(e) {
		var keyCode = e.keyCode;
		// if (keyCode === 13) {
			// drawText(this.value, parseInt(currX - offsetLeft, 10), parseInt(currY - offsetTop - 20, 10));
			// document.body.removeChild(this);
			// hasInput = false;
		// }
	}

	function drawText(txt, x, y) {
		ctx.textBaseline = 'top';
		ctx.textAlign = 'left';
		ctx.font = font;
		ctx.fillText(txt, x, y);
	}

	function findxy(res, e) {
		if(tool === 3) {
			return;
		}

		if (res == 'down') {
			prevX = currX;
			prevY = currY;
			currX = e.clientX - canvas.offsetLeft - offsetLeft;
			currY = e.clientY - canvas.offsetTop - offsetTop;
	
			flag = true;
			dot_flag = true;
			if(tool === 2) {
				ctx.clearRect(currX, currY, 15, 15);
			} else if (dot_flag) {
				ctx.beginPath();
				ctx.fillStyle = pen_color;
				ctx.fillRect(currX, currY, 2, 2);
				ctx.closePath();
				dot_flag = false;
			}
		}
		if (res == 'up' || res == "out") {
			flag = false;
		}
		if (res == 'move') {
			if (flag) {
				prevX = currX;
				prevY = currY;
				currX = e.clientX - canvas.offsetLeft - offsetLeft;
				currY = e.clientY - canvas.offsetTop - offsetTop;
				draw();
			}
		}
	}

	function selectPen() {
		pen.checked = true;
		erase.checked = false;
		text.checked = false;
		tool = 1;
	}

	function selectErase() {
		pen.checked = false;
		erase.checked = true;
		text.checked = false;
		tool = 2;
	}

	function selectText() {
		pen.checked = false;
		erase.checked = false;
		text.checked = true;
		tool = 3;
	}

	function loadimage(event) {
		eraseAll();
		var input, file, img;
		files = event.target.files;

        input = document.getElementById('load_data');
		file = input.files[0];
		reader.onload = createImage;
		reader.readAsDataURL(file);
		function createImage() {
            img = new Image();
            img.onload = imageLoaded;
            img.src = reader.result;
        }
		function imageLoaded() {
            ctx.drawImage(img,0,0);
        }
	}

	function clickload() {
		return true;
	}

	</script>
</head>
<body style="background:#ddd;" onload="init()">
	<img id='img' style="display: none;"/>
	<div id="the-palace" style="margin: 30px auto; max-width: 1000px; position:relative; min-height: 500px;">
		<div style="width:100%; height: 20px; display: inline-flex">
			<input type="checkbox" id="pen" onchange="selectPen()">Pen</input>
			<input type="checkbox" id="erase" onchange="selectErase()" style="margin-left: 10px;">Eraser</input>
			<input type="checkbox" id="text" onchange="selectText()" style="margin-left: 10px;">Text</input>
			<div style="margin-left: 20px;">Select Color</div>
			<select onchange="color(this);" class="color" id="list-color" style="margin-left: 10px;">
				<option id="black" value="Black">Black</option>
				<option id="green" value="Green">Green</option>
				<option id="blue" value="Blue">Blue</option>
				<option id="red" value="Red">Red</option>
				<option id="pink" value="Pink">Pink</option>
				<option id="yellow" value="Yellow">Yellow</option>
			</select>
			<a id="downloader" download="image.png"  onclick='return save()'>
				<input type="button" style="margin-left: 20px;" id="btn_save" value="Save" />
			</a>
			<input id="load_data"  type='file' onchange="loadimage(event)" style="display: none;"></input>
			<label for="load_data">
				<input type="button" style="margin-left: 10px;" value="Load" id="btn_load"/>
			</label>
			
		</div>
		<canvas id="can" style="position:absolute;top:30px;left:0; width:100%; height:100%; background: white;"></canvas>
	</div>
</body>
</html>